<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- CSS BOOTSTRAP 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" 
    crossorigin="anonymous">
    

    <style>
        #wrap{
            width: 100vw;
            height: 50vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .center{
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        button{
            margin: 10px 0;
        }

    </style>

</head>
<body>
    
    <div id="wrap">

        <div class="card">
            <div class="card-body center">
                <button type="button" class="btn btn-info" onclick="conectarMetaMask()">Conectar Con MetaMask</button>

                <h2>Seleccionar Localidad</h2>

                <div class="dropdown center">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                        Localidades
                    </button>
                    <ul id="localidades" class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                    </ul>
                </div>

                <button type="button" class="btn btn-success" onclick="IrAVotar()">Votar</button>

            </div>
        </div>

    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" 
    crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0-rc.0/web3.min.js"></script>

    <!-- Optional JavaScript; choose one of the two! -->
    <script>
        const API_URL = 'http://localhost:5000/api';
        let localidades = [];
        let localidadSelected = null;
        let metamaskConectado = null;

        // EVENTS

        // POST REQUEST
        const postrequest = async (path, body) => {
            const myRequest = new Request(`${API_URL}${path}`, {method: 'POST', body: JSON.stringify(body)});
            
            let response;
            response = await fetch(request)
                .then( response => { return response.json() })
                .catch( error => { console.error(error)})
            
            return response
        }
        
        // GET REQUEST
        const getrequest = async (path, queryparams) => {
            // Contruir QueryParams
            qp = '?'
            for (let key in queryparams){
                qp += `${key}=${queryparams[key]}&`
            }
            // Para quitar el ultimo &
            qp = qp.slice(0, qp.length - 1);

            // Request
            const request = new Request(`${API_URL}${path}${qp}`, {method: 'GET'});
            let response;

            response = await fetch(request)
                .then( response => { return response.json() })
                .catch( error => { console.error("Ocurrio un error", error)});

            return await response
        }

        // FUNCIONES 
        // Obtener las localidades registradas en el SC
        let getLocalidades = async () => {
            // Obtener localidades
            localidades = await getrequest('/localidades/')

            // Colocar las localidades en el dropdown
            let dd = document.getElementById('localidades');
            for (let localidad of localidades){
                // Crear el elemento
                let li = document.createElement('li');
                let button = document.createElement('button');
                button.classList = 'dropdown-item localidad-item';
                button.appendChild(document.createTextNode(localidad))
                li.appendChild(button);
                dd.appendChild(li);
            }

            // Agregar evento cuando se haga click
            document.querySelectorAll('.localidad-item').forEach(
                item => item.addEventListener('click', (event) => {
                    localidadSelected = event.target.textContent;
                    document.getElementById('dropdownMenuButton1').textContent = localidadSelected;
                    console.log(localidadSelected);
                })
            )

        }

        let isMetamaskConectado = () => {
            return Boolean(metamaskConectado);
        }

        let isMetaMaskSupported = () => {
            return window.ethereum && window.ethereum.isMetaMask
        }

        let conectarMetaMask = async () => {

            if (!isMetaMaskSupported()){
                alert("No tienes MetaMask instalado");
                return;
            }

            if (isMetamaskConectado()){
                alert("Ya esta conectado");
                return;
            }

            metamaskConectado = await window.ethereum.enable();
            metamaskConectado = await metamaskConectado;
            metamaskConectado = metamaskConectado[0];
            return;
        }

        // Verificar que el votante esta registrado y obtener los candidatos de la localidad elegida
        let postVotante = async (address, localidad) => {

            if (!isMetamaskConectado()){
                alert("Necesitas estar conectado con MetaMask");
                return;
            }

            const body = {
                address: metamaskConectado,
            }
            const response = await postrequest(`/votar/${localidad}/`, body)
            await response
        }

        // EJECUCIONES AL INICIAR
        getLocalidades();
        isMetamaskConectado();

    </script>

</body>
</html>